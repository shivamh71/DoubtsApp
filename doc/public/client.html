<!DOCTYPE html><html lang="en"><head><title>public/client</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="public/client"><meta name="groc-project-path" content="public/client.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">public/client.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-comment">//Cookie Functions</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCookie</span><span class="hljs-params">(cname)</span> </span>{
    <span class="hljs-keyword">var</span> name = cname + <span class="hljs-string">"="</span>;
    <span class="hljs-keyword">var</span> ca = <span class="hljs-built_in">document</span>.cookie.split(<span class="hljs-string">';'</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;ca.length; i++) {
        <span class="hljs-keyword">var</span> c = ca[i];
        <span class="hljs-keyword">while</span> (c.charAt(<span class="hljs-number">0</span>)==<span class="hljs-string">' '</span>) c = c.substring(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (c.indexOf(name) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> c.substring(name.length,c.length);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCookie</span><span class="hljs-params">(cname, cvalue, exdays)</span> </span>{
    <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    d.setTime(d.getTime() + (exdays*<span class="hljs-number">24</span>*<span class="hljs-number">60</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>));
    <span class="hljs-keyword">var</span> expires = <span class="hljs-string">"expires="</span>+d.toUTCString();
    <span class="hljs-built_in">document</span>.cookie = cname + <span class="hljs-string">"="</span> + cvalue + <span class="hljs-string">"; "</span> + expires;
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Client Configurations</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> reloadTime = <span class="hljs-number">5000000</span>; <span class="hljs-comment">// Miliseconds</span>
<span class="hljs-keyword">var</span> numRandomDoubts = <span class="hljs-number">5</span>; <span class="hljs-comment">// Random number of doubts to be displayed at the top</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>GLobal Variables</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> pseudo = <span class="hljs-string">""</span>, messageContainer, submitButton;
<span class="hljs-keyword">var</span> sortState = <span class="hljs-number">0</span>; <span class="hljs-comment">/*
						0 - Most Recent First
						1 - Most Recent Last
						2 - Most Upvoted First
						3 - Most Upvoted Last
					*/</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Init Function</p></div></div><div class="code"><div class="wrapper">$(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
	messageContainer = $(<span class="hljs-string">'#messageInput'</span>);
	submitButton = $(<span class="hljs-string">"#submit"</span>);
	bindButton();	
	<span class="hljs-keyword">if</span>(getCookie(<span class="hljs-string">'userName'</span>)==<span class="hljs-string">""</span>){
		$(<span class="hljs-string">"#alertPseudo"</span>).hide();
		BootstrapDialog.show({
			id: <span class="hljs-string">"mymy"</span>,
			title: <span class="hljs-string">'Enter Username'</span>,
			message: $(<span class="hljs-string">'&lt;input id="pseudoInput" type="text" class="form-control" placeholder="Username" /&gt;'</span>),
			buttons: [{
				label: <span class="hljs-string">'Submit'</span>,
				cssClass: <span class="hljs-string">'btn-primary'</span>,
				hotkey: <span class="hljs-number">13</span>,
				action: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dialogItself)</span></span>{
					setPseudo(dialogItself);
				},
			}]
		});
	}<span class="hljs-keyword">else</span>{
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">" COoooooooooooooooookie  is "</span> + getCookie(<span class="hljs-string">'userName'</span>));
		socket.emit(<span class="hljs-string">'setPseudo'</span>,getCookie(<span class="hljs-string">"userName"</span>)+<span class="hljs-string">'!'</span>);
		pseudo = getCookie(<span class="hljs-string">'userName'</span>);
	}
	$(<span class="hljs-string">"#pseudoSubmit"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
		setPseudo();
	});
	submitButton.click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
		sentMessage();
	});
	$(<span class="hljs-string">'#messageInput'</span>).keypress(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
		<span class="hljs-keyword">if</span>(e.which==<span class="hljs-number">13</span>)
			sentMessage();
	});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Function to select random doubts to be displayed at the top after set interval</p></div></div><div class="code"><div class="wrapper">	setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">var</span> doubtList = $(<span class="hljs-string">'#chatEntries &gt; div'</span>);
		<span class="hljs-keyword">if</span>(doubtList.length &gt; numRandomDoubts){
			<span class="hljs-keyword">var</span> randArray = [];
			<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;numRandomDoubts;i++){
				randNum = <span class="hljs-built_in">Math</span>.floor((<span class="hljs-built_in">Math</span>.random() * doubtList.length));
				randArray.push(doubtList[randNum]);
				doubtList.splice(randNum,<span class="hljs-number">1</span>);
			}
			<span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">0</span>){
				randArray.sort(compareTime);
				doubtList.sort(compareTime);
			}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">1</span>){
				randArray.sort(compareTime).reverse();
				doubtList.sort(compareTime).get().reverse();
			}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">2</span>){
				randArray.sort(compareVote);
				doubtList.sort(compareVote);
			}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">3</span>){
				randArray.sort(compareVote).reverse();
				doubtList.sort(compareVote).get().reverse();
			}<span class="hljs-keyword">else</span>{
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Should not reach here !"</span>)
			}
			$(<span class="hljs-string">'#chatEntries'</span>).empty();
			<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;numRandomDoubts;i++){
				$(<span class="hljs-string">'#chatEntries'</span>).append(randArray[i].outerHTML);
			}
			<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;doubtList.length;i++){
				$(<span class="hljs-string">'#chatEntries'</span>).append(doubtList[i].outerHTML);
			}
		}
	},reloadTime);

});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Socket Functions</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> socket = io.connect();

socket.on(<span class="hljs-string">'connect'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'connected'</span>);
});

socket.on(<span class="hljs-string">'nbUsers'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span></span>{
	$(<span class="hljs-string">"#nbUsers"</span>).html(msg.nb);
});

socket.on(<span class="hljs-string">'message'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
	addMessage(data.doubtId ,data.upvotes, data.message, data.pseudo, data.date, <span class="hljs-literal">false</span>);
});

socket.on(<span class="hljs-string">'updateVote'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
	<span class="hljs-keyword">var</span> id = data.doubtId;
	<span class="hljs-keyword">var</span> count = data.count;
	$(<span class="hljs-string">'#'</span>+id+<span class="hljs-string">'&gt; .text'</span>).html(count);
});

socket.on(<span class="hljs-string">'setDoubtId'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
	$(<span class="hljs-string">"#Unknown"</span>).attr(<span class="hljs-string">"onclick"</span>,<span class="hljs-string">"deleteMessage("</span>+data+<span class="hljs-string">")"</span>);
	$(<span class="hljs-string">"#Unknown"</span>).attr(<span class="hljs-string">"id"</span>,<span class="hljs-string">''</span>+data);
});

socket.on(<span class="hljs-string">'deleteMessageFromServer'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
	<span class="hljs-built_in">document</span>.getElementById(data[<span class="hljs-string">'doubtId'</span>]).parentNode.parentNode.remove();
});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helper Functions</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sending a new doubt</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sentMessage</span><span class="hljs-params">()</span></span>{
	<span class="hljs-keyword">if</span>(messageContainer.val().trim()!=<span class="hljs-string">""</span>){
		<span class="hljs-keyword">if</span>(pseudo==<span class="hljs-string">""</span>){
			$(<span class="hljs-string">'#modalPseudo'</span>).modal(<span class="hljs-string">'show'</span>);
		}
		<span class="hljs-keyword">else</span>{
			<span class="hljs-keyword">var</span> doubt_content = messageContainer.val();
			<span class="hljs-keyword">var</span> date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
			date = date.toLocaleTimeString();
			addMessage(<span class="hljs-string">"Unknown"</span>, <span class="hljs-number">0</span> ,doubt_content,<span class="hljs-string">"ME"</span>,date,<span class="hljs-literal">true</span>);
			socket.emit(<span class="hljs-string">'message'</span>,doubt_content);
			messageContainer.val(<span class="hljs-string">''</span>);
			submitButton.button(<span class="hljs-string">'loading'</span>);
		}
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Deleting a message (User is allowed to delete only his doubt)</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteMessage</span><span class="hljs-params">(doubtId)</span></span>{
	bootbox.confirm(<span class="hljs-string">"Are you sure want to delete?"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span> </span>{
    	<span class="hljs-keyword">if</span>(result) socket.emit(<span class="hljs-string">'deleteMessage'</span>,doubtId);
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addMessage</span><span class="hljs-params">(doubtId,upvotes,msg,pseudo,date,self)</span></span>{
	<span class="hljs-keyword">var</span> text = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">if</span>(getCookie(<span class="hljs-string">'userName'</span>)==pseudo){
		<span class="hljs-keyword">var</span> classDiv = <span class="hljs-string">"rowMessageSelf row"</span>;
		text += <span class="hljs-string">'&lt;div class="'</span> + classDiv + <span class="hljs-string">'"&gt;&lt;div class="col-md-11"&gt;&lt;p style="word-wrap:break-word" &gt; &lt;b&gt;'</span> + <span class="hljs-string">"ME"</span> + <span class="hljs-string">' , '</span>+ date + <span class="hljs-string">'&lt;/b&gt;&amp;nbsp&amp;nbsp&amp;nbsp'</span> + msg +<span class="hljs-string">'&lt;/div&gt;'</span>;
		text += <span class="hljs-string">'&lt;div class="col-md-1" &gt;&lt;button id="'</span>+ doubtId +  <span class="hljs-string">'" type="button" class="btn btn-default pull-right" onclick="deleteMessage('</span>+ doubtId +<span class="hljs-string">')" &gt;&lt;span class="glyphicon glyphicon-remove"&gt;&lt;/span&gt;&lt;span class="text"&gt;'</span>+upvotes+<span class="hljs-string">'&lt;/span&gt;&lt;/button&gt;&lt;/div&gt;'</span>;
	}
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(self){
		<span class="hljs-keyword">var</span> classDiv = <span class="hljs-string">"rowMessageSelf row"</span>;
		text += <span class="hljs-string">'&lt;div class="'</span> + classDiv + <span class="hljs-string">'"&gt;&lt;div class="col-md-11"&gt;&lt;p style="word-wrap:break-word" &gt; &lt;b&gt;'</span> + pseudo + <span class="hljs-string">' , '</span>+ date + <span class="hljs-string">'&lt;/b&gt;&amp;nbsp&amp;nbsp&amp;nbsp'</span> + msg +<span class="hljs-string">'&lt;/div&gt;'</span>;
		text += <span class="hljs-string">'&lt;div class="col-md-1" &gt;&lt;button id="'</span>+ doubtId +  <span class="hljs-string">'" type="button" class="btn btn-default pull-right" onclick="deleteMessage('</span>+ doubtId +<span class="hljs-string">')" &gt;&lt;span class="glyphicon glyphicon-remove"&gt;&lt;/span&gt;&lt;span class="text"&gt;'</span>+upvotes+<span class="hljs-string">'&lt;/span&gt;&lt;/button&gt;&lt;/div&gt;'</span>;
	}
	<span class="hljs-keyword">else</span>{
		<span class="hljs-keyword">var</span> classDiv = <span class="hljs-string">"rowMessage row"</span>;
		text += <span class="hljs-string">'&lt;div class="'</span> + classDiv + <span class="hljs-string">'"&gt;&lt;div class="col-md-11"&gt;&lt;p style="word-wrap:break-word" &gt; &lt;b&gt;'</span> + pseudo + <span class="hljs-string">' , '</span>+ date + <span class="hljs-string">'&lt;/b&gt;&amp;nbsp&amp;nbsp&amp;nbsp'</span> + msg + <span class="hljs-string">'&lt;/div&gt;'</span>;
		text += <span class="hljs-string">'&lt;div class="col-md-1"&gt;&lt;button id="'</span>+doubtId+<span class="hljs-string">'" value="OFF" type="button" onclick="upvoteFunction('</span>+ doubtId +<span class="hljs-string">')" class="btn btn-default pull-right vote"&gt;&lt;span class="glyphicon glyphicon-arrow-up"&gt;&lt;/span&gt;&lt;span class="text"&gt;'</span>+upvotes+<span class="hljs-string">'&lt;/span&gt;&lt;/button&gt;&lt;/div&gt;'</span>;
	}

	$(<span class="hljs-string">"#chatEntries"</span>).prepend(text);
	$(<span class="hljs-string">'#messageInput'</span>).val(<span class="hljs-string">''</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindButton</span><span class="hljs-params">()</span></span>{
	submitButton.button(<span class="hljs-string">'loading'</span>);
	messageContainer.on(<span class="hljs-string">'input'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">if</span>(messageContainer.val()==<span class="hljs-string">""</span>)
			submitButton.button(<span class="hljs-string">'loading'</span>);
		<span class="hljs-keyword">else</span>
			submitButton.button(<span class="hljs-string">'reset'</span>);
	});
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPseudo</span><span class="hljs-params">(dialogItself)</span></span>{
	<span class="hljs-keyword">if</span>(getCookie(<span class="hljs-string">'userName'</span>)==<span class="hljs-string">""</span> &amp;&amp; $(<span class="hljs-string">"#pseudoInput"</span>).val()!=<span class="hljs-string">""</span>){
		socket.emit(<span class="hljs-string">'setPseudo'</span>,$(<span class="hljs-string">"#pseudoInput"</span>).val());
		socket.on(<span class="hljs-string">'pseudoStatus'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
			<span class="hljs-keyword">if</span>(data == <span class="hljs-string">"ok"</span>){
				dialogItself.close();
				pseudo = $(<span class="hljs-string">"#pseudoInput"</span>).val();
				setCookie( <span class="hljs-string">"userName"</span>, pseudo, <span class="hljs-number">1</span> );
			}
			<span class="hljs-keyword">else</span>{
				BootstrapDialog.alert(<span class="hljs-string">'Username already taken.'</span>);
			}
		});
	}
	<span class="hljs-keyword">else</span>{
		BootstrapDialog.alert(<span class="hljs-string">'Username field is empty.'</span>);
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Changing appearance of upvote button after it is clicked</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upvoteFunction</span><span class="hljs-params">(doubtId)</span></span>{
	socket.emit(<span class="hljs-string">'upvote'</span>, doubtId);
	<span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>.getElementById(doubtId).value == <span class="hljs-string">"OFF"</span>){
		<span class="hljs-built_in">document</span>.getElementById(doubtId).value = <span class="hljs-string">"ON"</span>;
		<span class="hljs-built_in">document</span>.getElementById(doubtId).setAttribute(<span class="hljs-string">"style"</span>,<span class="hljs-string">"background-color:#AAA"</span>);

	}<span class="hljs-keyword">else</span>{
		<span class="hljs-built_in">document</span>.getElementById(doubtId).value = <span class="hljs-string">"OFF"</span>;
		<span class="hljs-built_in">document</span>.getElementById(doubtId).setAttribute(<span class="hljs-string">"style"</span>,<span class="hljs-string">"background-color:none"</span>);
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Comparator used to sort doubts by number of upvotes</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareVote</span><span class="hljs-params">(a,b)</span></span>{
	<span class="hljs-keyword">var</span> count1 = <span class="hljs-built_in">parseInt</span>($(a).find(<span class="hljs-string">".btn .text"</span>).text());
	<span class="hljs-keyword">var</span> count2 = <span class="hljs-built_in">parseInt</span>($(b).find(<span class="hljs-string">".btn .text"</span>).text());
	<span class="hljs-keyword">return</span> count1 &lt; count2;
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Comparator used to sort doubts by time</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareTime</span><span class="hljs-params">(a,b)</span></span>{
	<span class="hljs-keyword">var</span> id1 = <span class="hljs-built_in">parseInt</span>($(a).find(<span class="hljs-string">".vote"</span>)[<span class="hljs-number">0</span>].id);
	<span class="hljs-keyword">var</span> id2 = <span class="hljs-built_in">parseInt</span>($(b).find(<span class="hljs-string">".vote"</span>)[<span class="hljs-number">0</span>].id);
	<span class="hljs-keyword">return</span> id1 &lt; id2;
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Function to be called when user chooses to sort the doubts based on one of the provided options
Default sort state is Most Recent First
Randomly chosen doubts are sorted using the same criterion amongst themselves</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">displaySorted</span><span class="hljs-params">()</span></span>{
	sortState = $(<span class="hljs-string">'.form-control :selected'</span>).index();
	<span class="hljs-keyword">var</span> doubtList = $(<span class="hljs-string">'#chatEntries &gt; div'</span>);
	<span class="hljs-keyword">if</span>(doubtList.length &gt; numRandomDoubts){
		<span class="hljs-keyword">var</span> randArray = [];
		<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;numRandomDoubts;i++){
			randNum = <span class="hljs-built_in">Math</span>.floor((<span class="hljs-built_in">Math</span>.random() * doubtList.length));
			randArray.push(doubtList[randNum]);
			doubtList.splice(randNum,<span class="hljs-number">1</span>);
		}
		<span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">0</span>){
			randArray.sort(compareTime);
			doubtList.sort(compareTime);
		}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">1</span>){
			randArray.sort(compareTime).reverse();
			doubtList.sort(compareTime).get().reverse();
		}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">2</span>){
			randArray.sort(compareVote);
			doubtList.sort(compareVote);
		}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sortState == <span class="hljs-number">3</span>){
			randArray.sort(compareVote).reverse();
			doubtList.sort(compareVote).get().reverse();
		}<span class="hljs-keyword">else</span>{
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Should not reach here"</span>);
		}
		$(<span class="hljs-string">'#chatEntries'</span>).empty();
		<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;numRandomDoubts;i++){
			$(<span class="hljs-string">'#chatEntries'</span>).append(randArray[i].outerHTML);
		}
		<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;doubtList.length;i++){
			$(<span class="hljs-string">'#chatEntries'</span>).append(doubtList[i].outerHTML);
		}
	}
}</div></div></div></div></body></html>